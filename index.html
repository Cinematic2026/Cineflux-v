<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CineFlux OS | Ultimate Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root { --primary: #3b82f6; --bg: #000; --surface: #0a0a0a; --text: #fff; --header-h: 80px; --tabs-h: 60px; }
        body.light-mode { --bg: #f2f2f7; --surface: #ffffff; --text: #000; --primary: #007aff; }
        body.neon-mode { --bg: #0d001a; --surface: #1a0033; --primary: #ff00ff; --text: #fff; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; transition: 0.3s; }

        /* SCROLLBAR OCULTA PERO FUNCIONAL */
        ::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; }

        /* VISTAS */
        .view { display: none; min-height: 100vh; padding-top: calc(var(--header-h) + var(--tabs-h) + 20px); padding-bottom: 120px; overflow-x: hidden; }
        
        /* HOME: Padding 0 para el Hero inmersivo */
        #v-home { padding-top: 0 !important; } 

        /* CORRECCIÓN FINAL: Cuando se filtra por categoría, empujamos el contenido hacia abajo */
        #category-grid {
            padding-top: calc(var(--header-h) + var(--tabs-h) + 20px);
        }

        .view.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .view#v-search, .view#v-profile { padding-top: 100px; } 

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER & TABS STICKY INTELIGENTE */
        header { 
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h); 
            z-index: 2000; transition: transform 0.4s ease, background 0.3s; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }
        
        #tabs-menu {
            position: fixed; top: var(--header-h); left: 0; width: 100%; height: var(--tabs-h);
            z-index: 1900; display: flex; gap: 12px; padding: 0 20px;
            align-items: center; overflow-x: auto; 
            transition: transform 0.4s ease, top 0.4s ease, background 0.3s;
            background: linear-gradient(to bottom, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0) 100%);
        }

        /* Clases para ocultar al hacer scroll */
        body.scroll-down header { transform: translateY(-100%); }
        body.scroll-down #tabs-menu { transform: translateY(-140%); } 

        .tab-item {
            padding: 8px 18px; border-radius: 100px; font-size: 0.8rem; font-weight: 700;
            text-transform: capitalize; white-space: nowrap; cursor: pointer;
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .tab-item.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }

        /* GRID RESPONSIVO */
        .grid-responsive { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 20px; }
        @media (min-width: 600px) { .grid-responsive { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .grid-responsive { grid-template-columns: repeat(5, 1fr); } }

        /* CARDS & RATINGS */
        .section-title { padding: 10px 20px 15px; font-size: 1.2rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 20px; background: var(--primary); border-radius: 2px; display: block; }
        
        .h-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 0 20px 20px; }
        
        .card { 
            min-width: 140px; border-radius: 16px; overflow: hidden; background: var(--surface); 
            border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; aspect-ratio: 2/3; position: relative; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .card:active { transform: scale(0.95); }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ETIQUETA DE PUNTUACIÓN */
        .rating-badge {
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0,0.75); backdrop-filter: blur(4px);
            color: #fff; font-size: 10px; font-weight: 900;
            padding: 4px 8px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 3px;
            z-index: 10;
        }
        .rating-badge span { font-size: 10px; color: #fbbf24; }

        /* NAV BAR */
        .nav-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(15,15,15,0.85); backdrop-filter: blur(20px); border-radius: 25px; display: flex; justify-content: space-evenly; align-items: center; border: 1px solid rgba(255,255,255,0.08); z-index: 4000; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .nav-item { color: #666; text-align: center; font-size: 10px; font-weight: 700; transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item span { font-size: 24px; }

        /* AJUSTES */
        .setting-group { background: var(--surface); border-radius: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .setting-label { font-size: 14px; font-weight: 500; opacity: 0.8; }
        .setting-val { font-size: 13px; font-weight: 700; color: var(--primary); }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; overflow-y: auto; }
        
        /* REPRODUCTOR MEJORADO */
        #m-player-view { background: #000; position: fixed; inset: 0; z-index: 6000; display: flex; flex-direction: column; }
        .player-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; position: absolute; top: 0; left: 0; width: 100%; z-index: 20; background: linear-gradient(to bottom, black, transparent); pointer-events: none; }
        .player-header button { pointer-events: auto; }
        
        .viewport-container { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; width: 100%; height: 100%; }
        .viewport { width: 100%; height: 100%; border: none; }
        
        .player-controls { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            padding: 30px 25px 40px; 
            background: linear-gradient(to top, black, transparent); 
            z-index: 20; 
            display: flex; flex-direction: column; gap: 15px;
        }

        .report-bubble {
            position: absolute; bottom: 90px; right: 25px;
            background: #1a1a1a; padding: 10px; border-radius: 15px;
            display: flex; flex-direction: column; gap: 5px;
            border: 1px solid rgba(255,255,255,0.1);
            transform: scale(0); transform-origin: bottom right; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .report-bubble.open { transform: scale(1); }
        .report-btn { padding: 10px 15px; border-radius: 10px; background: rgba(255,255,255,0.05); color: white; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="flex items-center justify-between px-6">
        <div class="flex items-center gap-2">
            <span class="material-symbols-rounded text-blue-500 text-3xl shadow-lg">movie_filter</span>
            <div class="text-xl font-black italic tracking-tighter text-white drop-shadow-md">CINEFLUX <span class="text-blue-500 not-italic">OS</span></div>
        </div>
        <img id="nav-pfp" onclick="app.nav('profile')" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-9 h-9 rounded-full border border-white/20 object-cover cursor-pointer shadow-lg">
    </header>

    <div id="tabs-menu"></div>

    <main id="v-home" class="view active">
        <div id="hero" class="relative w-full h-[75vh] mx-auto mt-0 rounded-b-[40px] overflow-hidden bg-cover bg-center shadow-2xl mb-8">
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent flex flex-col justify-end p-6 md:p-10">
                <div class="pt-20"> <div id="hero-tag" class="bg-blue-500 text-white text-[9px] font-black px-3 py-1 rounded-md w-max mb-3 uppercase tracking-wider shadow-lg shadow-blue-500/50">Recomendado</div>
                    <h1 id="hero-title" class="text-4xl md:text-5xl font-black mb-3 leading-tight drop-shadow-xl">Cargando...</h1>
                    <div class="flex flex-wrap items-center gap-3 mb-4 text-xs font-bold text-gray-300 drop-shadow-md">
                        <span id="hero-year">2024</span>
                        <span class="w-1 h-1 bg-gray-500 rounded-full"></span>
                        <span id="hero-rating" class="text-yellow-400 flex items-center gap-1"><span class="material-symbols-rounded text-sm">star</span> 0.0</span>
                        <span class="w-1 h-1 bg-gray-500 rounded-full"></span>
                        <span id="hero-studio" class="text-blue-400">Studio</span>
                    </div>
                    <p id="hero-sinopsis" class="text-gray-300 text-sm mb-6 line-clamp-2 max-w-xl drop-shadow-md">...</p>
                    <div class="flex gap-3">
                        <button id="hero-play" class="flex-1 bg-white text-black h-14 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-gray-200 transition active:scale-95 shadow-lg shadow-white/10">
                            <span class="material-symbols-rounded fill-1">play_arrow</span> REPRODUCIR
                        </button>
                        <button id="hero-fav-btn-action" class="w-14 h-14 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/10 active:scale-95 transition">
                            <span id="hero-fav-icon" class="material-symbols-rounded">add</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="fav-row" class="hidden animate-fade-in">
            <h2 class="section-title">Mi Lista</h2>
            <div id="fav-container" class="h-scroll"></div>
        </div>

        <div id="dynamic-content"></div>
        <div id="category-grid" class="grid-responsive hidden pb-32"></div>
    </main>

    <main id="v-search" class="view px-5">
        <h1 class="text-3xl font-black mb-6">Explorar</h1>
        <div class="bg-[#151515] p-4 rounded-2xl flex items-center border border-white/5 mb-8 focus-within:border-blue-500 transition shadow-lg">
            <span class="material-symbols-rounded text-gray-500">search</span>
            <input type="text" id="search-input" oninput="app.search(this.value)" placeholder="Películas, géneros, actores..." class="bg-transparent border-none outline-none ml-3 w-full text-white font-bold placeholder-gray-600">
        </div>
        <div id="search-grid" class="grid-responsive"></div>
    </main>

    <main id="v-profile" class="view px-5">
        <h1 class="text-3xl font-black mb-6">Configuración</h1>
        
        <div class="flex items-center gap-5 mb-8 bg-gradient-to-r from-blue-900/20 to-transparent p-5 rounded-[25px] border border-blue-500/20">
            <div class="relative w-16 h-16 group">
                <img id="p-img" src="" class="w-full h-full rounded-2xl border-2 border-blue-500 object-cover shadow-lg shadow-blue-500/20">
                <input type="file" id="file-input" hidden accept="image/*" onchange="profile.changePhoto(event)">
                <div class="absolute -bottom-2 -right-2 bg-blue-500 p-1.5 rounded-full border-2 border-black cursor-pointer active:scale-90 transition" onclick="document.getElementById('file-input').click()">
                    <span class="material-symbols-rounded text-xs text-white block">edit</span>
                </div>
            </div>
            <div class="flex-1">
                <label class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Nombre de Usuario</label>
                <input type="text" id="p-name-input" class="bg-transparent text-xl font-black w-full outline-none text-white border-b border-transparent focus:border-blue-500 transition placeholder-gray-600" placeholder="Escribe tu nombre">
            </div>
        </div>

        <h3 class="text-[11px] font-black text-gray-500 mb-3 ml-2 tracking-[2px] uppercase">Sistema & Ubicación</h3>
        <div class="setting-group">
            <div class="setting-item">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-rounded text-gray-500">public</span>
                    <span class="setting-label">País Local</span>
                </div>
                <span id="sys-country" class="setting-val flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Detectando...
                </span>
            </div>
            <div class="setting-item">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-rounded text-gray-500">schedule</span>
                    <span class="setting-label">Hora Local</span>
                </div>
                <span id="sys-time" class="setting-val font-mono">--:--:--</span>
            </div>
             <div class="setting-item">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-rounded text-gray-500">timer</span>
                    <span class="setting-label">Tiempo de Sesión</span>
                </div>
                <span id="sys-timer" class="setting-val text-green-500 font-mono">00:00:00</span>
            </div>
        </div>

        <h3 class="text-[11px] font-black text-gray-500 mb-3 ml-2 tracking-[2px] uppercase">Apariencia</h3>
        <div class="setting-group">
            <div class="setting-item">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-rounded text-gray-500">palette</span>
                    <span class="setting-label">Tema Visual</span>
                </div>
                <select id="theme-selector" onchange="ui.setTheme(this.value)" class="bg-transparent font-black text-blue-500 outline-none text-right">
                    <option value="dark">Dark Mode</option>
                    <option value="light">Light Mode</option>
                    <option value="neon">Neon Cyber</option>
                </select>
            </div>
        </div>
        
        <button onclick="app.reset()" class="w-full p-4 text-red-500 font-black text-xs tracking-[2px] uppercase bg-red-500/10 rounded-2xl border border-red-500/20 active:scale-95 transition mb-10">Borrar Datos y Reiniciar</button>
    </main>

    <div id="m-movie" class="modal animate-[fadeIn_0.3s_ease]">
        <div id="m-info-view">
            <div id="m-banner" class="w-full h-[60vh] bg-cover bg-center relative">
                <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-center z-50">
                    <button onclick="app.closeModal()" class="bg-black/50 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md border border-white/10 active:scale-90 transition">
                        <span class="material-symbols-rounded text-white">arrow_back</span>
                    </button>
                    <button id="m-fav-btn" class="bg-black/50 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md border border-white/10 active:scale-90 transition">
                        <span class="material-symbols-rounded text-white">add</span>
                    </button>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/30 to-transparent"></div>
            </div>

            <div class="px-6 pb-24 -mt-32 relative z-10">
                <div class="flex items-start justify-between mb-2">
                    <h1 id="m-title" class="text-3xl font-black leading-tight max-w-[80%]">Título</h1>
                    <div class="bg-white/10 backdrop-blur-md px-3 py-1 rounded-lg border border-white/10 flex flex-col items-center">
                        <span class="text-[10px] uppercase font-bold text-gray-400">Rating</span>
                        <span id="m-rate-badge" class="font-black text-yellow-400 text-sm">0.0</span>
                    </div>
                </div>
                
                <div class="flex gap-3 text-[11px] font-bold text-gray-400 uppercase tracking-wide mb-6">
                    <span id="m-year">2024</span> • <span id="m-runtime">0 MIN</span> • <span id="m-studio" class="text-blue-500">Studio</span>
                </div>

                <button id="m-play-btn" class="w-full bg-white text-black h-16 rounded-2xl font-black text-lg mb-8 flex items-center justify-center gap-2 shadow-lg shadow-white/10 active:scale-95 transition">
                    <span class="material-symbols-rounded fill-1">play_arrow</span> REPRODUCIR AHORA
                </button>

                <p id="m-plot" class="text-gray-300 leading-relaxed mb-8 text-sm font-light">Sinopsis...</p>

                <div class="grid grid-cols-2 gap-3 mb-8">
                    <div class="bg-[#111] p-4 rounded-xl border border-white/5">
                        <span class="text-[9px] text-gray-500 font-black block mb-1 uppercase">Director</span>
                        <p id="m-dir" class="text-xs font-bold text-white truncate">---</p>
                    </div>
                    <div class="bg-[#111] p-4 rounded-xl border border-white/5">
                        <span class="text-[9px] text-gray-500 font-black block mb-1 uppercase">Ganancia</span>
                        <p id="m-revenue" class="text-xs font-bold text-green-500">---</p>
                    </div>
                </div>

                <h3 class="font-black mb-4 text-sm">Reparto Principal</h3>
                <div id="m-cast" class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide"></div>
            </div>
        </div>
    </div>

    <div id="m-player-view" class="hidden">
        <div class="player-header">
            <button onclick="app.closePlayer()" class="text-white opacity-80 hover:opacity-100 transition">
                <span class="material-symbols-rounded text-4xl shadow-black drop-shadow-md">expand_more</span>
            </button>
            <div class="bg-red-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest text-white shadow-lg animate-pulse">En Vivo</div>
        </div>
        
        <div class="viewport-container">
            <iframe id="vEngine" class="viewport" src="" allow="autoplay; fullscreen; encrypted-media; picture-in-picture" frameborder="0"></iframe>
        </div>

        <div id="report-menu" class="report-bubble">
            <a href="#" id="btn-report-email" class="report-btn hover:bg-white/10"><span class="material-symbols-rounded text-sm">mail</span> Email</a>
            <a href="#" id="btn-report-tg" class="report-btn hover:bg-white/10"><span class="material-symbols-rounded text-sm">send</span> Telegram</a>
        </div>

        <div class="player-controls">
            <div class="flex justify-between items-end">
                <div>
                    <h2 id="p-overlay-title" class="text-2xl font-black text-white mb-1 drop-shadow-md">Título Película</h2>
                    <div class="flex items-center gap-3 text-xs font-bold text-gray-300 drop-shadow-md">
                        <span id="p-overlay-year">2024</span>
                        <span class="w-1 h-1 bg-white rounded-full"></span>
                        <span id="p-overlay-studio">Studio</span>
                        <span class="bg-yellow-500 text-black px-1.5 rounded text-[10px] font-black" id="p-overlay-rate">8.5</span>
                    </div>
                </div>
                <div class="flex gap-3">
                     <button onclick="app.toggleReport()" class="bg-white/10 w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md border border-white/10 active:scale-90 transition text-white">
                        <span class="material-symbols-rounded">flag</span>
                    </button>
                    <button onclick="app.shareMovie()" class="bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center shadow-lg shadow-blue-600/40 active:scale-90 transition text-white">
                        <span class="material-symbols-rounded">share</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <div onclick="app.nav('home', this)" class="nav-item active"><span class="material-symbols-rounded">home_filled</span>Inicio</div>
        <div onclick="app.nav('search', this)" class="nav-item"><span class="material-symbols-rounded">travel_explore</span>Buscar</div>
        <div onclick="app.nav('profile', this)" class="nav-item"><span class="material-symbols-rounded">settings</span>Ajustes</div>
    </nav>

    <script>
    /* ================================================================
   CONFIGURACIÓN Y DATOS (CINEFLUX OS)
   ================================================================ */
const TMDB_KEY = 'b6083b855479a79fd9acdb0a2789f126';
let lastScrollTop = 0;
let appStartTime = Date.now();
let currentMovieData = null; 

const CATALOGO = [
    { id: 1522377, link: "https://hgplaycdn.com/e/27tc341hgd98", categoria: "Estreno" },
    { id: 1180831, link: "https://hgplaycdn.com/e/27tc341hgd98", categoria: "Estreno" },
    { id: 1547050, link: "https://yuguaab.com/e/3urdbixpgqjr", categoria: "Estreno" },
    { id: 1242898, link: "https://vimeos.net/embed-gifb0mvp14aw.html", categoria: "Estreno" },
    { id: 533535, link: "https://vimeos.net/embed-gifb0mvp14aw.html", categoria: "Estreno" },
    { id: 1084242, link: "https://vimeos.net/embed-mjskmrhlb91i.html", categoria: "Estreno" },
    { id: 1387382, link: "https://player.cuevana.is/player.php?h=rxPRsRSX4IlkyS1F21W5j1LWaxDrSlOWwDzFztiv8jRa0TKuAj7i3ipYgfIdutaO", categoria: "Acción" },
    { id: 1556834, link: "https://vimeos.net/embed-4pahvxfpu00m.html", categoria: "Acción" },
    { id: 426063, link: "https://vimeos.net/embed-wuozbsxutkuj.html", categoria: "Terror" },
    { id: 1197137, link: "https://vimeos.net/embed-xjc6uuujzzax.html", categoria: "Terror" }
];

const CONTENT_LINKS = Object.fromEntries(CATALOGO.map(m => [m.id, m.link]));
const DATABASE = CATALOGO.reduce((acc, m) => {
    if (!acc[m.categoria]) acc[m.categoria] = [];
    acc[m.categoria].push(m.id);
    return acc;
}, {});

/* ================================================================
   MÓDULO GUARDIAN (CSS INTEGRADO + LÓGICA DE INTERCEPCIÓN)
   ================================================================ */
const guardian = {
    init() {
        const style = document.createElement('style');
        style.innerHTML = `
            .guardian-toast {
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-200%);
                background: rgba(10, 15, 25, 0.95); backdrop-filter: blur(12px);
                border: 1px solid #3b82f6; border-left: 5px solid #3b82f6;
                padding: 15px 25px; border-radius: 14px;
                display: flex; align-items: center; gap: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.6);
                z-index: 10000; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                opacity: 0; pointer-events: none; min-width: 320px;
            }
            .guardian-toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }
            .g-icon { color: #3b82f6; font-size: 24px; animation: pulseG 1.5s infinite; }
            @keyframes pulseG { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
            
            #guardian-shield {
                position: absolute; inset: 0; z-index: 99;
                background: rgba(0,0,0,0.01); cursor: pointer;
                display: flex; align-items: center; justify-content: center;
            }
            .shield-label {
                background: #3b82f6; color: white; padding: 6px 14px;
                border-radius: 20px; font-size: 11px; font-weight: 800;
                text-transform: uppercase; opacity: 0; transition: 0.3s;
            }
            #guardian-shield:active .shield-label { opacity: 1; }
        `;
        document.head.appendChild(style);

        const toast = document.createElement('div');
        toast.id = 'guardian-toast';
        toast.className = 'guardian-toast';
        toast.innerHTML = `
            <span class="material-symbols-rounded g-icon">security</span>
            <div>
                <div style="color:white; font-size:13px; font-weight:900; margin-bottom:2px">CINEFLUX GUARDIAN</div>
                <div id="g-text" style="color:#94a3b8; font-size:11px">Analizando integridad del stream...</div>
            </div>
        `;
        document.body.appendChild(toast);
    },
    notify(msg) {
        const t = document.getElementById('guardian-toast');
        document.getElementById('g-text').innerText = msg;
        t.classList.add('active');
        if(navigator.vibrate) navigator.vibrate(50);
        setTimeout(() => t.classList.remove('active'), 3500);
    }
};

/* ================================================================
   CORE APP
   ================================================================ */
const app = {
    init() {
        this.renderHome();
        this.renderTabs();
        profile.init();
        favs.init();
        ui.init();
        guardian.init(); // Iniciar sistema de seguridad
        window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
    },

    handleScroll() {
        const st = window.pageYOffset || document.documentElement.scrollTop;
        if (st > lastScrollTop && st > 50) document.body.classList.add('scroll-down');
        else document.body.classList.remove('scroll-down');
        lastScrollTop = st <= 0 ? 0 : st;
    },

    renderTabs() {
        const menu = document.getElementById('tabs-menu');
        const categories = ["Inicio", ...Object.keys(DATABASE)];
        menu.innerHTML = categories.map((cat, i) => `
            <div class="tab-item ${i===0?'active':''}" onclick="app.filterCat(this, '${cat}')">${cat}</div>
        `).join('');
    },

    filterCat(el, cat) {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        const dynamic = document.getElementById('dynamic-content');
        const grid = document.getElementById('category-grid');
        const hero = document.getElementById('hero');
        const favRow = document.getElementById('fav-row');

        if(cat === "Inicio") {
            dynamic.classList.remove('hidden');
            grid.classList.add('hidden');
            hero.classList.remove('hidden');
            if(favs.list.length > 0) favRow.classList.remove('hidden');
        } else {
            dynamic.classList.add('hidden');
            grid.classList.remove('hidden');
            hero.classList.add('hidden');
            favRow.classList.add('hidden');
            this.renderCategoryGrid(cat);
        }
        window.scrollTo({top: 0, behavior: 'smooth'});
    },

    async renderCategoryGrid(cat) {
        const grid = document.getElementById('category-grid');
        grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">Cargando...</div>';
        const ids = DATABASE[cat] || [];
        let html = '';
        for(const id of ids) {
            try {
                const m = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_KEY}&language=es-MX`).then(r => r.json());
                html += this.createCard(m);
            } catch(e) {}
        }
        grid.innerHTML = html;
    },

    createCard(m) {
        const rate = m.vote_average.toFixed(1);
        const rateColor = rate >= 7 ? 'text-green-400' : (rate >= 5 ? 'text-yellow-400' : 'text-red-400');
        return `<div class="card" onclick="app.openModal(${m.id})">
            <img src="https://image.tmdb.org/t/p/w500${m.poster_path}" loading="lazy">
            <div class="rating-badge"><span class="material-symbols-rounded" style="font-size:10px">star</span><span class="${rateColor}">${rate}</span></div>
        </div>`;
    },

    nav(id, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(`v-${id}`).classList.add('active');
        if(el) el.classList.add('active');
        document.getElementById('tabs-menu').style.display = (id === 'home') ? 'flex' : 'none';
        window.scrollTo(0,0);
    },

    async renderHome() {
        const container = document.getElementById('dynamic-content');
        container.innerHTML = "";
        for (const [title, ids] of Object.entries(DATABASE)) {
            const row = document.createElement('div');
            row.innerHTML = `<h2 class="section-title">${title}</h2><div id="row-${title.replace(/\s/g,'')}" class="h-scroll"></div>`;
            container.appendChild(row);
            const el = document.getElementById(`row-${title.replace(/\s/g,'')}`);
            const promises = ids.map(id => fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_KEY}&language=es-MX`).then(r => r.json()));
            const movies = await Promise.all(promises);
            el.innerHTML = movies.map(m => this.createCard(m)).join('');
        }
        this.initHero();
    },

    async initHero() {
        const allIds = [].concat(...Object.values(DATABASE));
        const randomId = allIds[Math.floor(Math.random() * allIds.length)];
        try {
            const d = await fetch(`https://api.themoviedb.org/3/movie/${randomId}?api_key=${TMDB_KEY}&language=es-MX`).then(r => r.json());
            document.getElementById('hero').style.backgroundImage = `url(https://image.tmdb.org/t/p/original${d.backdrop_path})`;
            document.getElementById('hero-title').innerText = d.title;
            document.getElementById('hero-year').innerText = d.release_date.split('-')[0];
            document.getElementById('hero-rating').innerHTML = `<span class="material-symbols-rounded text-sm">star</span> ${d.vote_average.toFixed(1)}`;
            document.getElementById('hero-sinopsis').innerText = d.overview;
            document.getElementById('hero-play').onclick = () => this.openModal(randomId);
            const favBtn = document.getElementById('hero-fav-btn-action');
            favBtn.onclick = () => favs.toggle(randomId);
            favs.updateIcon(document.getElementById('hero-fav-icon'), randomId);
        } catch(e) {}
    },

    async openModal(id) {
        const mod = document.getElementById('m-movie');
        mod.style.display = 'block';
        document.body.style.overflow = 'hidden';
        try {
            const [d, c] = await Promise.all([
                fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_KEY}&language=es-MX`).then(r => r.json()),
                fetch(`https://api.themoviedb.org/3/movie/${id}/credits?api_key=${TMDB_KEY}`).then(r => r.json())
            ]);
            currentMovieData = { ...d, studio: d.production_companies[0]?.name || 'N/A' };
            document.getElementById('m-banner').style.backgroundImage = `url(https://image.tmdb.org/t/p/original${d.backdrop_path})`;
            document.getElementById('m-title').innerText = d.title;
            document.getElementById('m-rate-badge').innerText = d.vote_average.toFixed(1);
            document.getElementById('m-year').innerText = d.release_date.split('-')[0];
            document.getElementById('m-runtime').innerText = `${d.runtime} MIN`;
            document.getElementById('m-studio').innerText = currentMovieData.studio;
            document.getElementById('m-plot').innerText = d.overview || "---";
            document.getElementById('m-dir').innerText = c.crew.find(p => p.job === 'Director')?.name || '---';
            document.getElementById('m-revenue').innerText = d.revenue > 0 ? `$${(d.revenue/1e6).toFixed(1)}M` : 'N/A';
            document.getElementById('m-cast').innerHTML = c.cast.slice(0,8).map(a => `<div class="flex-shrink-0 text-center w-16"><img src="${a.profile_path?'https://image.tmdb.org/t/p/w200'+a.profile_path:'https://ui-avatars.com/api/?name='+a.name}" class="w-12 h-12 rounded-full mx-auto object-cover mb-2"><p class="text-[9px] font-bold text-gray-400 truncate">${a.name}</p></div>`).join('');
            const playBtn = document.getElementById('m-play-btn');
            if(CONTENT_LINKS[id]) {
                playBtn.onclick = () => this.openPlayer(CONTENT_LINKS[id]);
                playBtn.innerHTML = '<span class="material-symbols-rounded fill-1">play_arrow</span> REPRODUCIR';
                playBtn.disabled = false;
                playBtn.style.opacity = "1";
            } else {
                playBtn.innerText = "NO DISPONIBLE";
                playBtn.disabled = true;
                playBtn.style.opacity = "0.5";
            }
            const fBtn = document.getElementById('m-fav-btn');
            fBtn.onclick = () => { favs.toggle(id); favs.updateIcon(fBtn.querySelector('span'), id); };
            favs.updateIcon(fBtn.querySelector('span'), id);
        } catch (e) {}
    },

    /* ================================================================
       REPRODUCTOR REFORZADO (ESTILO 1DM)
       ================================================================ */
    openPlayer(url) {
        const playerView = document.getElementById('m-player-view');
        playerView.classList.remove('hidden');
        
        // Data overlay
        if(currentMovieData) {
            document.getElementById('p-overlay-title').innerText = currentMovieData.title;
            document.getElementById('p-overlay-year').innerText = currentMovieData.release_date.split('-')[0];
            document.getElementById('p-overlay-studio').innerText = currentMovieData.studio;
            document.getElementById('p-overlay-rate').innerText = currentMovieData.vote_average.toFixed(1);
            const subject = encodeURIComponent(`Reporte: ${currentMovieData.title}`);
            document.getElementById('btn-report-email').href = `mailto:support@cineflux.com?subject=${subject}`;
            document.getElementById('btn-report-tg').href = `https://t.me/cinefluxsupport?start=${currentMovieData.id}`;
        }

        const container = document.querySelector('.viewport-container');
        // REINICIO TOTAL DEL CONTENEDOR
        container.innerHTML = ''; 

        // 1. EL ESCUDO DE INTERCEPCIÓN (Capta el primer toque sucio)
        const shield = document.createElement('div');
        shield.id = 'guardian-shield';
        shield.innerHTML = '<div class="shield-label">Preparando canal seguro...</div>';
        
        // 2. EL IFRAME (Sin sandbox para no ser detectado)
        const iframe = document.createElement('iframe');
        iframe.id = 'vEngine';
        iframe.className = 'viewport';
        iframe.setAttribute('allow', 'autoplay; fullscreen');
        iframe.setAttribute('frameborder', '0');
        iframe.src = url;

        container.appendChild(shield);
        container.appendChild(iframe);

        // Lógica de "Limpieza de Canal"
        shield.onclick = () => {
            guardian.notify("INTENTO DE REDIRECCIÓN BLOQUEADO");
            shield.style.transition = "opacity 0.6s";
            shield.style.opacity = "0";
            
            // Después de 0.8s el escudo desaparece y el usuario puede dar Play real
            setTimeout(() => {
                shield.remove();
                guardian.notify("CANAL SEGURO: PUEDES REPRODUCIR");
            }, 800);
        };

        // Anti-salida de la página
        window.onbeforeunload = () => "Guardian Activo: ¿Deseas salir del reproductor?";

        if (playerView.requestFullscreen) playerView.requestFullscreen();
    },

    closePlayer() {
        // DESTRUCCIÓN DEL IFRAME para matar el proceso y audio
        document.querySelector('.viewport-container').innerHTML = ''; 
        document.getElementById('m-player-view').classList.add('hidden');
        window.onbeforeunload = null;
        if (document.exitFullscreen) document.exitFullscreen();
        document.getElementById('report-menu').classList.remove('open');
    },

    closeModal() { this.closePlayer(); document.getElementById('m-movie').style.display = 'none'; document.body.style.overflow = 'auto'; },
    toggleReport() { document.getElementById('report-menu').classList.toggle('open'); },
    
    async shareMovie() {
        if(!currentMovieData) return;
        const url = CONTENT_LINKS[currentMovieData.id] || window.location.href;
        if(navigator.share) navigator.share({title: currentMovieData.title, url: url});
        else alert("Link copiado");
    },

    async search(q) {
        const grid = document.getElementById('search-grid');
        if(q.length < 3) return;
        try {
            const r = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${q}&language=es-MX`).then(res => res.json());
            grid.innerHTML = r.results.map(m => this.createCard(m)).join('');
        } catch(e) {}
    },

    reset() { if(confirm("¿Reiniciar ajustes?")) { localStorage.clear(); location.reload(); } }
};

/* ================================================================
   OTROS SISTEMAS
   ================================================================ */
const favs = {
    list: JSON.parse(localStorage.getItem('ghost_favs')) || [],
    init() { this.render(); },
    toggle(id) {
        if(this.list.includes(id)) this.list = this.list.filter(x => x !== id);
        else this.list.push(id);
        localStorage.setItem('ghost_favs', JSON.stringify(this.list));
        this.render();
        favs.updateIcon(document.getElementById('hero-fav-icon'), id);
    },
    updateIcon(el, id) {
        if(!el) return;
        const isFav = this.list.includes(id);
        el.innerText = isFav ? 'check' : 'add';
        el.style.color = isFav ? '#3b82f6' : '#fff';
    },
    async render() {
        const row = document.getElementById('fav-row');
        const cont = document.getElementById('fav-container');
        if(this.list.length === 0) { row?.classList.add('hidden'); return; }
        row?.classList.remove('hidden');
        cont.innerHTML = "";
        for(const id of this.list) {
            const m = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_KEY}&language=es-MX`).then(r => r.json());
            cont.innerHTML += `<div class="card" onclick="app.openModal(${id})"><img src="https://image.tmdb.org/t/p/w300${m.poster_path}"></div>`;
        }
    }
};

const ui = {
    async init() {
        setInterval(() => {
            document.getElementById('sys-time').innerText = new Date().toLocaleTimeString();
            const diff = Date.now() - appStartTime;
            const h = Math.floor(diff / 3600000).toString().padStart(2,'0');
            const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2,'0');
            const s = Math.floor((diff % 60000) / 1000).toString().padStart(2,'0');
            document.getElementById('sys-timer').innerText = `${h}:${m}:${s}`;
        }, 1000);
        try {
            const ipData = await fetch('https://ipapi.co/json/').then(r => r.json());
            document.getElementById('sys-country').innerText = ipData.country_name || "Globo";
        } catch(e) { document.getElementById('sys-country').innerText = "Offline"; }
        ui.setTheme(localStorage.getItem('app_theme') || 'dark');
    },
    setTheme(t) { document.body.className = t + '-mode'; localStorage.setItem('app_theme', t); }
};

const profile = {
    init() {
        document.getElementById('p-name-input').value = localStorage.getItem('p_name') || "";
        document.getElementById('p-img').src = localStorage.getItem('p_img') || "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix";
        document.getElementById('nav-pfp').src = document.getElementById('p-img').src;
        document.getElementById('p-name-input').addEventListener('input', (e) => localStorage.setItem('p_name', e.target.value));
    },
    changePhoto(e) {
        const reader = new FileReader();
        reader.onload = () => {
            localStorage.setItem('p_img', reader.result);
            document.getElementById('p-img').src = reader.result;
            document.getElementById('nav-pfp').src = reader.result;
        };
        if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
    }
};

app.init();
    </script>
</body>
</html>
